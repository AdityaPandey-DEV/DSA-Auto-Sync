name: Auto-organize LeetCode Problems by Difficulty

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  
  # Run on push to main branch (only if leetcode/ directory is modified)
  push:
    branches:
      - main
    paths:
      - 'leetcode/**'
      - '!leetcode/easy/**'
      - '!leetcode/medium/**'
      - '!leetcode/hard/**'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  organize-leetcode:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push changes
      actions: read    # Standard read permission
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better git diff
    
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
    
      - name: Run organization script
        id: organize
        run: |
          python3 scripts/organize_leetcode_by_readme.py
          exit_code=$?
          
          # Check if changes were made
          if [ -n "$(git status --porcelain leetcode/)" ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected in leetcode/ directory"
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes detected"
          fi
          
          exit $exit_code
    
      - name: Check for changes
        id: changes
        run: |
          if [ "${{ steps.organize.outputs.changes_made }}" == "true" ]; then
            echo "Changes detected, will commit and push"
          else
            echo "No changes, skipping commit"
          fi
    
      - name: Configure Git
        if: steps.organize.outputs.changes_made == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
    
      - name: Stage changes and get stats
        if: steps.organize.outputs.changes_made == 'true'
        id: stats
        run: |
          git add leetcode/
          
          # Count unique problem directories moved to each difficulty folder
          # Extract unique folder names from staged changes and count them
          EASY_LIST=$(git diff --cached --name-only | grep "^leetcode/easy/" | cut -d'/' -f3 | sort -u)
          MEDIUM_LIST=$(git diff --cached --name-only | grep "^leetcode/medium/" | cut -d'/' -f3 | sort -u)
          HARD_LIST=$(git diff --cached --name-only | grep "^leetcode/hard/" | cut -d'/' -f3 | sort -u)
          
          # Count lines (use awk for reliable counting)
          if [ -z "$EASY_LIST" ]; then
            EASY_COUNT=0
          else
            EASY_COUNT=$(echo "$EASY_LIST" | awk 'END {print NR}')
          fi
          
          if [ -z "$MEDIUM_LIST" ]; then
            MEDIUM_COUNT=0
          else
            MEDIUM_COUNT=$(echo "$MEDIUM_LIST" | awk 'END {print NR}')
          fi
          
          if [ -z "$HARD_LIST" ]; then
            HARD_COUNT=0
          else
            HARD_COUNT=$(echo "$HARD_LIST" | awk 'END {print NR}')
          fi
          
          # Set outputs
          echo "easy_count=${EASY_COUNT}" >> $GITHUB_OUTPUT
          echo "medium_count=${MEDIUM_COUNT}" >> $GITHUB_OUTPUT
          echo "hard_count=${HARD_COUNT}" >> $GITHUB_OUTPUT
          
          # Get trigger type
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "trigger=Daily scheduled run" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "trigger=Manual trigger" >> $GITHUB_OUTPUT
          else
            echo "trigger=Push to main branch" >> $GITHUB_OUTPUT
          fi
          
          # Get timestamp
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "üìä Statistics: Easy=$EASY_COUNT, Medium=$MEDIUM_COUNT, Hard=$HARD_COUNT"
    
      - name: Commit changes
        if: steps.organize.outputs.changes_made == 'true'
        run: |
          EASY=${{ steps.stats.outputs.easy_count }}
          MEDIUM=${{ steps.stats.outputs.medium_count }}
          HARD=${{ steps.stats.outputs.hard_count }}
          TRIGGER="${{ steps.stats.outputs.trigger }}"
          TIMESTAMP="${{ steps.stats.outputs.timestamp }}"
          
          COMMIT_MSG="Auto-organize LeetCode problems by difficulty

          - Moved ${EASY} problem(s) to easy/
          - Moved ${MEDIUM} problem(s) to medium/
          - Moved ${HARD} problem(s) to hard/
          
          Triggered by: ${TRIGGER}
          Date: ${TIMESTAMP}"
          
          git commit -m "$COMMIT_MSG" --no-verify
    
      - name: Fetch latest changes
        if: steps.organize.outputs.changes_made == 'true'
        run: |
          git fetch origin main
    
      - name: Rebase on latest main
        if: steps.organize.outputs.changes_made == 'true'
        run: |
          # Try rebase first
          if git rebase origin/main; then
            echo "‚úÖ Rebase successful"
          else
            echo "‚ö†Ô∏è  Rebase had conflicts, resolving..."
            
            # Abort rebase and use merge strategy instead
            git rebase --abort 2>/dev/null || true
            
            # Merge with strategy to prefer our moves
            if ! git merge origin/main --no-edit; then
              echo "Resolving merge conflicts..."
              
              # Handle file location conflicts
              # Files added in remote in old location should be moved to new location
              CONFLICTED=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "")
              
              if [ -n "$CONFLICTED" ]; then
                for file in $CONFLICTED; do
                  # If file is in leetcode root and problem folder was moved
                  if [[ "$file" == leetcode/* ]] && [[ "$file" != leetcode/easy/* ]] && [[ "$file" != leetcode/medium/* ]] && [[ "$file" != leetcode/hard/* ]]; then
                    PROBLEM_DIR=$(echo "$file" | cut -d'/' -f2)
                    
                    # Find where this problem was moved to
                    for diff in easy medium hard; do
                      if [ -d "leetcode/$diff/$PROBLEM_DIR" ]; then
                        echo "Moving conflicted file $file to leetcode/$diff/"
                        # Accept the file from remote
                        git checkout --theirs "$file" 2>/dev/null || true
                        # Move it to correct location
                        if [ -f "$file" ]; then
                          TARGET="leetcode/$diff/$file"
                          mkdir -p "$(dirname "$TARGET")"
                          mv "$file" "$TARGET" 2>/dev/null || cp "$file" "$TARGET" && rm "$file"
                          git add "$TARGET"
                          git rm "$file" 2>/dev/null || true
                        fi
                        break
                      fi
                    done
                  else
                    # Accept theirs for other conflicts
                    git checkout --theirs "$file" 2>/dev/null || git add "$file" 2>/dev/null || true
                  fi
                done
              fi
              
              # Stage all leetcode changes
              git add -A leetcode/ 2>/dev/null || true
              
              # Complete merge
              git commit --no-edit --no-verify || {
                echo "‚ö†Ô∏è  Could not resolve conflicts automatically"
                exit 1
              }
            fi
          fi
          
          # Re-stage any changes after rebase/merge
          if [ -n "$(git status --porcelain leetcode/)" ]; then
            git add leetcode/
          fi
    
      - name: Push changes
        if: steps.organize.outputs.changes_made == 'true'
        run: |
          git push origin main --no-verify
    
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.organize.outputs.changes_made }}" == "true" ]; then
            echo "‚úÖ Successfully organized LeetCode problems and pushed changes"
          else
            echo "‚úÖ All problems are already organized correctly. No changes needed."
          fi

